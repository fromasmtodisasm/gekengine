<?xml version="1.0"?>
<filter mode="lighting">
    <defines>
        <define name="gs_nLightTileSize" value="16" />
        <define name="gs_nMaxLights" value="254" />
    </defines>

    <blend>
        <color source="one" destination="one" operation="add" />
        <alpha source="one" destination="one" operation="add" />
    </blend>

    <buffers>
        <buffer name="Opaque.TileIndices" format="R_UINT8" count="ceil(%xsize%/gs_nLightTileSize)*ceil(%ysize%/gs_nLightTileSize)*gs_nMaxLights" />
    </buffers>

    <compute dispatch="ceil(%xsize%/gs_nLightTileSize),ceil(%ysize%/gs_nLightTileSize),1">
        <resources>
            <resource stage="0" source="Opaque.TileIndices" unorderedaccess="true" />
            <resource stage="1" source="Opaque.Depth" />
        </resources>

        <program source="%data%\programs\Opaque\Lighting.hlsl" entry="MainComputeProgram" />
    </compute>
    
    <pixel>
        <resources>
            <resource stage="1" source="Opaque.Albedo" />
            <resource stage="2" source="Opaque.Normal" />
            <resource stage="3" source="Opaque.Depth" />
            <resource stage="4" source="Opaque.Info" />
            <resource stage="5" source="Opaque.TileIndices" />
        </resources>

        <program source="%data%\programs\Opaque\Lighting.hlsl" entry="MainPixelProgram"/>
    </pixel>
</filter>
