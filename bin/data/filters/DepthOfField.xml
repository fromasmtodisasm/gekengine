<?xml version="1.0"?>
<filter>
    <textures>
        <depthBuffer bind="float" source="$standard" />
        <foregroundBuffer bind="float3" flags="target">R11G11B10_FLOAT</foregroundBuffer>
        <circleOfConfusion bind="float" flags="target">R16_FLOAT</circleOfConfusion>
    </textures>

    <buffers>
        <averageFocalDepth size="1" flags="unorderedAccess">R32_FLOAT</averageFocalDepth>
    </buffers>

    <defines>
        <focalRange>20.0</focalRange>

        <sampleCount type="int">4</sampleCount>
        <ringCount type="int">7</ringCount>

        <highlightThreshold>0.5</highlightThreshold>
        <highlightGain>10.0</highlightGain>

        <bokehEdgeBias>0.4</bokehEdgeBias>

        <enableChromaticAberation type="bool">true</enableChromaticAberation>
        <bokehChromaticAberation>0.75</bokehChromaticAberation>

        <enableDithering type="bool">true</enableDithering>

        <noiseStrength>0.0001</noiseStrength>

        <enableDepthBlur type="bool">false</enableDepthBlur>
        <depthBlurSize>2.0</depthBlurSize>

        <!-- next part is experimental
                    not looking good with small sample and ring count
                    looks okay starting from sampleCount = 4, ringCount = 4
                    -->
        <enablePentagon type="bool">false</enablePentagon>
        <pentagonFeathering>0.4</pentagonFeathering>

        <gaussianRadius type="int">7</gaussianRadius>
        <gaussianSigma>1</gaussianSigma>

    </defines>

    <passes>
        <AdaptFocalDepth compute="(1, 1, 1)" entry="mainComputeProgram">
            <defines>
                <adaptionRate>5.0</adaptionRate>
            </defines>

            <resources>
                <depthBuffer />
            </resources>

            <unorderedaccess>
                <averageFocalDepth />
            </unorderedaccess>
        </AdaptFocalDepth>

        <SeparateLayers entry="mainPixelProgram">
            <resources>
                <averageFocalDepth />
                <depthBuffer />
                <screen />
            </resources>

            <targets>
                <circleOfConfusion />
                <foregroundBuffer />
                <screenBuffer />
            </targets>
        </SeparateLayers>
        
        <GatherBackground entry="mainPixelProgram">
            <resources>
                <circleOfConfusion />
                <screenBuffer />
            </resources>

            <targets>
                <screen />
            </targets>
        </GatherBackground>

        <ScatterForeground entry="mainPixelProgram">
            <blendstates>
                <color source="one" destination="inverse_source_alpha" operation="add" />
                <alpha source="one" destination="one" operation="add" />
            </blendstates>

            <resources>
                <circleOfConfusion />
                <foregroundBuffer />
            </resources>

            <targets>
                <screen />
            </targets>
        </ScatterForeground>
    </passes>
</filter>
