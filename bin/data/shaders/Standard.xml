<?xml version="1.0"?>
<shader>
    <material>
        <maps>
            <albedo bind="float4" default="*color:(1,0,1,1)">Texture2D</albedo>
            <normal bind="float2" default="*normal:(0,0,1)">Texture2D</normal>
            <roughness bind="float" default="*color:.25">Texture2D</roughness>
            <metalness bind="float" default="*color:0">Texture2D</metalness>
        </maps>
    </material>

    <defines>
        <tileSize>32</tileSize>
        <dispatchWidth>ceil(displayWidth / tileSize)</dispatchWidth>
		<dispatchHeight>ceil(displayHeight / tileSize)</dispatchHeight>
        <bloomSigma>1.75</bloomSigma>
        <bloomRadius>7</bloomRadius>
        <bloomScale>2</bloomScale>
    </defines>

    <depth>D32</depth>

    <textures>
        <albedoBuffer bind="float3" flags="target">byte4</albedoBuffer>
        <materialBuffer bind="float2" flags="target">byte2</materialBuffer>
        <normalBuffer bind="half2" flags="target">half2</normalBuffer>
        <depthBuffer bind="float" flags="target">float</depthBuffer>
        <luminatedBuffer bind="float3" flags="target">float4</luminatedBuffer>
        <luminanceBuffer bind="float" flags="target, mipmaps">float</luminanceBuffer>
        <effectsBuffer bind="float4" flags="target, readWrite">byte4</effectsBuffer>
        <averageLuminance bind="float" flags="target, unorderedAccess, readWrite" width="1" height="1">float</averageLuminance>
    </textures>

    <buffers>
        <tileIndexList size="dispatchWidth * dispatchHeight * maximumListSize" flags="unorderedAccess">byte</tileIndexList>
    </buffers>

    <block>
        <pass mode="forward">
            <depthstates>
                <comparison>lessequal</comparison>
                <writemask>all</writemask>
                <clear>1</clear>
            </depthstates>

            <renderstates>
                <cullmode>back</cullmode>
            </renderstates>

            <targets>
                <albedoBuffer />
                <materialBuffer />
                <normalBuffer />
                <depthBuffer />
            </targets>

            <program>
                <entry>mainPixelProgram</entry>
                <source>Standard\StoreDeferred</source>
            </program>
        </pass>

        <pass mode="deferred">
            <targets>
                <luminatedBuffer />
            </targets>

            <resources>
                <albedoBuffer />
                <materialBuffer />
                <normalBuffer />
                <depthBuffer />
            </resources>

            <program>
                <entry>mainPixelProgram</entry>
                <source>Standard\AmbientLighting</source>
            </program>
        </pass>
    </block>

    <block lighting="true">
        <pass mode="compute">
            <resources>
                <depthBuffer />
            </resources>

            <unorderedaccess>
                <tileIndexList />
            </unorderedaccess>

            <program>
                <compute>
                    <width>dispatchWidth</width>
                    <height>dispatchHeight</height>
                    <depth>1</depth>
                </compute>
                <entry>mainComputeProgram</entry>
                <source>Standard\TiledLightCulling</source>
            </program>
        </pass>

        <pass mode="deferred">
            <blendstates>
                <color source="one" destination="one" operation="add" />
                <writemask>rgb</writemask>
            </blendstates>

            <targets>
                <luminatedBuffer />
            </targets>

            <resources>
                <tileIndexList />
                <albedoBuffer />
                <materialBuffer />
                <normalBuffer />
                <depthBuffer />
            </resources>

            <program>
                <entry>mainPixelProgram</entry>
                <source>Standard\AccumulateLighting</source>
            </program>
        </pass>
    </block>

    <block>
        <pass mode="deferred">
            <resources>
                <luminatedBuffer />
                <averageLuminance actions="flip" />
                <normalBuffer />
                <depthBuffer />
            </resources>

            <targets>
                <effectsBuffer />
                <luminanceBuffer />
            </targets>

            <program>
                <entry>mainPixelProgram</entry>
                <source>Standard\PrepareEffects</source>
            </program>
        </pass>

        <pass mode="deferred">
            <resources>
                <effectsBuffer actions="flip" />
            </resources>

            <targets>
                <effectsBuffer />
            </targets>

            <defines>
                <bloomAxis>float2(1, 0)</bloomAxis>
            </defines>

            <program>
                <entry>mainPixelProgram</entry>
                <source>Standard\BlurEffects</source>
            </program>
        </pass>

        <pass mode="deferred">
            <resources>
                <effectsBuffer actions="flip" />
            </resources>

            <targets>
                <effectsBuffer />
            </targets>

            <defines>
                <bloomAxis>float2(0, 1)</bloomAxis>
            </defines>

            <program>
                <entry>mainPixelProgram</entry>
                <source>Standard\BlurEffects</source>
            </program>
        </pass>

        <pass mode="deferred">
            <resources>
                <luminanceBuffer actions="generateMipMaps" />
                <averageLuminance />
            </resources>

            <targets>
                <averageLuminance />
            </targets>

            <program>
                <entry>mainPixelProgram</entry>
                <source>Standard\AdaptiveLuminance</source>
            </program>
        </pass>
    </block>

    <block>
        <pass mode="deferred">
            <resources>
                <luminatedBuffer />
                <averageLuminance />
                <albedoBuffer />
                <materialBuffer />
                <normalBuffer />
                <depthBuffer />
                <effectsBuffer actions="flip" />
            </resources>

            <program>
                <entry>mainPixelProgram</entry>
                <source>Standard\PresentEffects</source>
            </program>
        </pass>
    </block>
</shader>
