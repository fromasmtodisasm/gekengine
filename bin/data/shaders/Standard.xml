<?xml version="1.0"?>
<shader>
    <material>
        <maps>
            <albedo bind="float4" loadFlags="">Texture2D</albedo>
            <normal bind="float3">Texture2D</normal>
            <roughness bind="float">Texture2D</roughness>
            <metalness bind="float">Texture2D</metalness>
        </maps>
        <properties>
            <color>float4</color>
        </properties>
    </material>

    <defines>
        <tileSize>32</tileSize>
        <dispatchWidth>ceil(%displayWidth% / %tileSize%)</dispatchWidth>
		<dispatchHeight>ceil(%displayHeight% / %tileSize%)</dispatchHeight>
    </defines>

    <depth>D32</depth>

    <targets>
        <albedoBuffer bind="float3">byte4</albedoBuffer>
        <materialBuffer bind="float2">byte2</materialBuffer>
        <normalBuffer bind="float2">half2</normalBuffer>
        <depthBuffer bind="float">float</depthBuffer>
        <compositeBuffer bind="float3">float4</compositeBuffer>
    </targets>

    <buffers>
        <tileIndexList size="%dispatchWidth% * %dispatchHeight% * %lightListSize%">byte</tileIndexList>
        <exposureBuffer size="1">float</exposureBuffer>
    </buffers>

    <pass mode="forward">
        <depthstates>
            <comparison>lessequal</comparison>
            <writemask>all</writemask>
            <clear>1</clear>
        </depthstates>

        <renderstates>
            <cullmode>back</cullmode>
        </renderstates>

        <targets>
            <albedoBuffer />
            <materialBuffer />
            <normalBuffer />
            <depthBuffer />
        </targets>

        <program>
            <entry>mainPixelProgram</entry>
            <source>Standard\Deferred</source>
        </program>
    </pass>

    <pass mode="compute" lighting="true">
        <resources>
            <depthBuffer />
        </resources>

        <unorderedaccess>
            <tileIndexList />
        </unorderedaccess>

        <program>
			<compute>
				<width>%dispatchWidth%</width>
				<height>%dispatchHeight%</height>
				<depth>1</depth>
			</compute>
            <entry>mainComputeProgram</entry>
            <source>Standard\Tiled</source>
        </program>
    </pass>

    <pass mode="deferred" lighting="true">
        <blend>
            <color source="one" destination="one" operation="add" />
            <alpha source="one" destination="one" operation="add" />
        </blend>

        <targets clear="0,0,0,0">
            <compositeBuffer />
        </targets>

        <resources>
            <tileIndexList />
            <albedoBuffer />
            <materialBuffer />
            <normalBuffer />
            <depthBuffer />
        </resources>

        <program>
            <entry>mainPixelProgram</entry>
            <source>Standard\Lighting</source>
        </program>
    </pass>

    <pass mode="compute">
        <resources>
            <compositeBuffer />
        </resources>

        <unorderedaccess>
            <exposureBuffer />
        </unorderedaccess>

        <program>
            <compute>
                <width>%dispatchWidth%</width>
                <height>%dispatchHeight%</height>
                <depth>1</depth>
            </compute>
            <entry>mainComputeProgram</entry>
            <source>Standard\Exposure</source>
        </program>
    </pass>

    <pass mode="deferred">
        <resources>
            <exposureBuffer />
            <compositeBuffer />
            <albedoBuffer />
            <materialBuffer />
            <normalBuffer />
            <depthBuffer />
        </resources>

        <program>
            <entry>mainPixelProgram</entry>
            <source>Standard\Final</source>
        </program>
    </pass>
</shader>
