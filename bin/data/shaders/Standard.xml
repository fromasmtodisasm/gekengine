<?xml version="1.0"?>
<shader>
    <defines>
        <lightTileSize>32</lightTileSize>
    </defines>

    <depth format="D32" comparison="lessequal" writemask="all" clear="1"/>

    <targets>
        <albedo>RGBA_UINT8</albedo>
        <normal>RG_HALF</normal>
        <depth>R_FLOAT</depth> 
        <info>RGBA_UINT8</info>
    </targets>

    <buffers>
        <tileIndices size="ceil(%viewWidth%/%lightTileSize%)*ceil(%viewWidth%/%lightTileSize%)*%lightBatchSize%">R_UINT8</tileIndices>
    </buffers>

    <material>
        <maps>
            <albedo/>
            <normal/>
            <info/>
        </maps>
        <properties>
            <color>float4</color>
        </properties>
    </material>

    <pass mode="forward">
        <states cullmode="back" />

        <targets>
            <albedo/>
            <normal/>
            <depth/>
            <info/>
        </targets>

        <pixel>
            <program source="Standard\Deferred" entry="mainPixelProgram" />
        </pixel>
    </pass>

    <pass mode="lighting">
        <blend>
            <color source="one" destination="one" operation="add" />
            <alpha source="one" destination="one" operation="add" />
        </blend>

        <buffers>
            <tileIndices/>
        </buffers>

        <compute dispatch="ceil(%viewWidth%/%lightTileSize%),ceil(%viewWidth%/%lightTileSize%),1">
            <resources>
                <resource stage="0" source="tileIndices" unorderedaccess="true" />
                <resource stage="1" source="depth" />
            </resources>

            <program source="Standard\Lighting" entry="mainComputeProgram" />
        </compute>

        <pixel>
            <resources>
                <resource stage="1" source="depth" />
                <resource stage="2" source="albedo" />
                <resource stage="3" source="normal" />
                <resource stage="4" source="info" />
                <resource stage="5" source="tileIndices" />
            </resources>

            <program source="Standard\Lighting" entry="mainPixelProgram"/>
        </pixel>
    </pass>
</shader>
