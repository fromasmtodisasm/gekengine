<?xml version="1.0"?>
<shader>
    <material>
        <maps>
            <albedo>texture2D</albedo>
            <normal>texture2D</normal>
            <info>texture2D</info>
        </maps>
        <properties>
            <color>float4</color>
        </properties>
    </material>

    <defines>
        <lightTileSize>32</lightTileSize>
		<lightListSize>256</lightListSize>
    </defines>

    <depth>D32</depth>

    <targets>
        <materialAlbedo>RGBA_UINT8</materialAlbedo>
        <materialNormal>RG_HALF</materialNormal>
        <materialDepth>R_FLOAT</materialDepth> 
        <materialInfo>RGBA_UINT8</materialInfo>
    </targets>

    <buffers>
        <tileIndexList size="ceil(%shaderWidth% / %lightTileSize%) * ceil(%shaderWidth% / %lightTileSize%) * %lightListSize%">R_UINT8</tileIndexList>
        <lightList size="%lightListSize%">LIGHT</lightList>
    </buffers>

    <pass mode="forward">
		<depthstates>
			<comparison>lessequal</comparison>
			<writemask>all</writemask>
			<clear>1</clear>
		</depthstates>

        <renderstates>
			<cullmode>back</cullmode>
		</renderstates>

        <targets>
            <albedoBuffer />
            <normalBuffer />
            <depthBuffer />
            <infoBuffer />
        </targets>

        <pixel>
            <resources>
				<materialAlbedo />
				<materialNormal />
				<materialDepth />
				<materialInfo />
            </resources>

            <program source="Standard\Deferred" entry="mainPixelProgram" />
        </pixel>
    </pass>

    <pass mode="lighting">
        <blendstates>
			<target>
				<color source="one" destination="one" operation="add" />
				<alpha source="one" destination="one" operation="add" />
			</target>
        </blendstates>

        <compute dispatch="ceil(%viewWidth% / %lightTileSize%), ceil(%viewWidth% / %lightTileSize%), 1">
            <resources>
                <lightList />
                <depthBuffer />
            </resources>

            <unorderedaccess>
                <tileIndexList />
            </unorderedaccess>

            <program source="Standard\Lighting" entry="mainComputeProgram" />
        </compute>

        <pixel>
            <resources>
                <lightList />
                <tileIndexList />
                <albedoBuffer />
                <normalBuffer />
                <depthBuffer />
                <infoBuffer />
            </resources>

            <program source="Standard\Lighting" entry="mainPixelProgram" />
        </pixel>
    </pass>
</shader>
