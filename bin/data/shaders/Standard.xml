<?xml version="1.0"?>
<shader>
    <material>
        <maps>
            <albedo>Texture2D</albedo>
            <normal>Texture2D</normal>
            <info>Texture2D</info>
        </maps>
        <properties>
            <color>float4</color>
        </properties>
    </material>

    <defines>
        <lightTileSize>32</lightTileSize>
    </defines>

    <depth>D32</depth>

    <targets>
        <albedoBuffer>RGBA_UINT8</albedoBuffer>
        <normalBuffer>RG_HALF</normalBuffer>
        <depthBuffer>R_FLOAT</depthBuffer> 
        <infoBuffer>RGBA_UINT8</infoBuffer>
    </targets>

    <buffers>
        <tileIndexList size="ceil(%displayWidth% / %lightTileSize%) * ceil(%displayWidth% / %lightTileSize%) * %lightListSize%">R_UINT8</tileIndexList>
    </buffers>

    <pass mode="forward">
		<depthstates>
			<comparison>lessequal</comparison>
			<writemask>all</writemask>
			<clear>1</clear>
		</depthstates>

        <renderstates>
			<cullmode>back</cullmode>
		</renderstates>

        <targets>
            <albedoBuffer />
            <normalBuffer />
            <depthBuffer />
            <infoBuffer />
        </targets>

        <pixel>
            <resources>
				<albedo />
				<normal />
				<info />
            </resources>

            <program source="Standard\Deferred" entry="mainPixelProgram" />
        </pixel>
    </pass>

    <pass mode="lighting">
        <blendstates>
			<target>
				<color source="one" destination="one" operation="add" />
				<alpha source="one" destination="one" operation="add" />
			</target>
        </blendstates>

        <compute dispatch="ceil(%viewWidth% / %lightTileSize%), ceil(%viewWidth% / %lightTileSize%), 1">
            <resources>
                <lightList />
                <depthBuffer />
            </resources>

            <unorderedaccess>
                <tileIndexList />
            </unorderedaccess>

            <program source="Standard\Lighting" entry="mainComputeProgram" />
        </compute>

        <pixel>
            <resources>
                <lightList />
                <tileIndexList />
                <albedoBuffer />
                <normalBuffer />
                <depthBuffer />
                <infoBuffer />
            </resources>

            <program source="Standard\Lighting" entry="mainPixelProgram" />
        </pixel>
    </pass>
</shader>
