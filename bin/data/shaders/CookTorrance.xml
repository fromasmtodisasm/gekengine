<?xml version="1.0"?>
<shader priority="1">
    <lighting>
        <lightsPerPass>255</lightsPerPass>
    </lighting>

    <material>
        <solid>
            <albedo bind="float4" pattern="system" parameters="debug">Texture2D</albedo>
            <normal bind="float2" pattern="system" parameters="flat">Texture2D</normal>
            <roughness bind="float" pattern="color" parameters=".5">Texture2D</roughness>
            <metalness bind="float" pattern="color" parameters=".5">Texture2D</metalness>
        </solid>
    </material>

    <defines>
        <tileSize>32</tileSize>
        <dispatchWidth>ceil(displayWidth / tileSize)</dispatchWidth>
		<dispatchHeight>ceil(displayHeight / tileSize)</dispatchHeight>
        <shadowRadius>2.0</shadowRadius>
        <shadowStrength>0.25</shadowStrength>
        <shadowTapCount integer="true">32</shadowTapCount>
        <shadowSpiralCount>13</shadowSpiralCount>
    </defines>

    <depth>D32_FLOAT</depth>

    <textures>
        <albedoBuffer bind="float3" flags="target">R11G11B10_FLOAT</albedoBuffer>
        <materialBuffer bind="float2" flags="target">R8G8_UNORM</materialBuffer>
        <normalBuffer bind="half2" flags="target">R16G16_FLOAT</normalBuffer>
        <ambientBuffer bind="float" flags="target">R8_UNORM</ambientBuffer>
        <finalBuffer bind="float3" flags="target">R11G11B10_FLOAT</finalBuffer>
    </textures>

    <buffers>
        <tileIndexList size="dispatchWidth * dispatchHeight * (lightsPerPass + 1)" flags="unorderedAccess">R8_UINT</tileIndexList>
    </buffers>

    <blocks>
        <DeferredPass>
            <passes>
                <StoreDeferred forward="solid" entry="mainPixelProgram">
                    <depthstates>
                        <comparison>less_equal</comparison>
                        <writemask>all</writemask>
                        <clear>1</clear>
                    </depthstates>

                    <renderstates>
                        <cullmode>back</cullmode>
                    </renderstates>

                    <targets>
                        <albedoBuffer />
                        <materialBuffer />
                        <normalBuffer />
                    </targets>
                </StoreDeferred>

                <AmbientCalculation entry="mainPixelProgram">
                    <resources>
                        <normalBuffer />
                        <depth />
                    </resources>

                    <targets>
                        <ambientBuffer />
                    </targets>
                </AmbientCalculation>

                <AmbientLighting entry="mainPixelProgram">
                    <resources>
                        <albedoBuffer />
                        <ambientBuffer />
                    </resources>

                    <targets>
                        <finalBuffer />
                    </targets>
                </AmbientLighting>
            </passes>
        </DeferredPass>

        <LightingPass lighting="true">
            <passes>
                <TiledLightCulling compute="dispatchWidth, dispatchHeight, 1" entry="mainComputeProgram">
                    <resources>
                        <depth />
                    </resources>

                    <unorderedaccess>
                        <tileIndexList />
                    </unorderedaccess>
                </TiledLightCulling>

                <AccumulateLighting entry="mainPixelProgram">
                    <blendstates unified="true">
                        <color source="one" destination="one" operation="add" />
                    </blendstates>

                    <resources>
                        <tileIndexList />
                        <albedoBuffer />
                        <materialBuffer />
                        <normalBuffer />
                        <depth />
                    </resources>

                    <targets>
                        <finalBuffer />
                    </targets>
                </AccumulateLighting>
            </passes>
        </LightingPass>
    </blocks>
</shader>
