<?xml version="1.0"?>
<shader priority="1">
    <input>
        <position type="float3" semantic="POSITION" semanticindex="0" />
        <texCoord type="float2" semantic="TEXCOORD" semanticindex="0" />
        <normal type="float3" semantic="NORMAL" semanticindex="0" />
        <color type="float4" semantic="COLOR" semanticindex="0" />
        <isFrontFacing type="isFrontFacing" />
    </input>

    <lighting>
        <lightsPerPass>255</lightsPerPass>
    </lighting>

    <material>
        <solid>
            <albedo bind="float4" pattern="system" parameters="debug">Texture2D</albedo>
            <normal bind="float2" pattern="system" parameters="flat">Texture2D</normal>
            <roughness bind="float" pattern="color" parameters=".5">Texture2D</roughness>
            <metalness bind="float" pattern="color" parameters=".5">Texture2D</metalness>
        </solid>
    </material>

    <defines>
        <tileSize>32</tileSize>
        <dispatchWidth>ceil(displayWidth / tileSize)</dispatchWidth>
		<dispatchHeight>ceil(displayHeight / tileSize)</dispatchHeight>
        <gaussianRadius type="int">12</gaussianRadius>
        <gaussianSigma>5.0</gaussianSigma>
        <bilateralEdgeSharpness>0.1</bilateralEdgeSharpness>
    </defines>

    <depth>D32_FLOAT</depth>

    <textures>
        <albedoBuffer bind="float3" flags="target">R11G11B10_FLOAT</albedoBuffer>
        <materialBuffer bind="float2" flags="target">R8G8_UNORM</materialBuffer>
        <normalBuffer bind="half2" flags="target">R16G16_FLOAT</normalBuffer>
        <ambientBuffer bind="float" flags="target">R8_UNORM</ambientBuffer>
        <gaussianBuffer bind="float" flags="target">R8_UNORM</gaussianBuffer>
        <finalBuffer bind="float3" flags="target">R11G11B10_FLOAT</finalBuffer>
    </textures>

    <buffers>
        <tileIndexList size="dispatchWidth * dispatchHeight * (lightsPerPass + 1)" flags="unorderedAccess">R8_UINT</tileIndexList>
    </buffers>

    <blocks>
        <DeferredPass>
            <passes>
                <StoreDeferred forward="solid" entry="mainPixelProgram">
                    <depthstates>
                        <comparison>less_equal</comparison>
                        <writemask>all</writemask>
                        <clear>1</clear>
                    </depthstates>

                    <renderstates>
                        <cullmode>back</cullmode>
                    </renderstates>

                    <targets>
                        <albedoBuffer />
                        <materialBuffer />
                        <normalBuffer />
                    </targets>
                </StoreDeferred>

                <AmbientCalculation entry="mainPixelProgram">
                    <defines>
                        <ambientRadius>2.0</ambientRadius>
                        <ambientTapCount type="uint">32</ambientTapCount>
                        <ambientSpiralCount>13</ambientSpiralCount>
                    </defines>

                    <resources>
                        <normalBuffer />
                        <depth />
                    </resources>

                    <targets>
                        <ambientBuffer />
                    </targets>
                </AmbientCalculation>

                <AmbientBlur entry="mainPixelProgram">
                    <defines>
                        <blurAxis type="int2">(1,0)</blurAxis>
                    </defines>

                    <resources>
                        <depth />
                        <ambientBuffer>sourceBuffer</ambientBuffer>
                    </resources>

                    <targets>
                        <gaussianBuffer />
                    </targets>                
                </AmbientBlur>

                <AmbientBlur entry="mainPixelProgram">
                    <defines>
                        <blurAxis type="int2">(0,1)</blurAxis>
                    </defines>

                    <resources>
                        <depth />
                        <gaussianBuffer>sourceBuffer</gaussianBuffer>
                    </resources>

                    <targets>
                        <ambientBuffer />
                    </targets>                
                </AmbientBlur>
                
                <AmbientLighting entry="mainPixelProgram">
                    <resources>
                        <albedoBuffer />
                        <ambientBuffer />
                        <depth />
                    </resources>

                    <targets>
                        <finalBuffer />
                    </targets>
                </AmbientLighting>
            </passes>
        </DeferredPass>

        <LightingPass lighting="true">
            <passes>
                <TiledLightCulling compute="(dispatchWidth, dispatchHeight, 1)" entry="mainComputeProgram">
                    <resources>
                        <depth />
                    </resources>

                    <unorderedaccess>
                        <tileIndexList />
                    </unorderedaccess>
                </TiledLightCulling>

                <AccumulateLighting entry="mainPixelProgram">
                    <blendstates unified="true">
                        <color source="one" destination="one" operation="add" />
                    </blendstates>

                    <resources>
                        <tileIndexList />
                        <albedoBuffer />
                        <materialBuffer />
                        <normalBuffer />
                        <depth />
                    </resources>

                    <targets>
                        <finalBuffer />
                    </targets>
                </AccumulateLighting>
            </passes>
        </LightingPass>
    </blocks>
</shader>
