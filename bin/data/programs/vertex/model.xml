<?xml version="1.0"?>
<program>
    <layout>
		<element type="rgb_float" name="POSITION" index="0" class="vertex" slot="0" />
		<element type="rg_float" name="TEXCOORD" index="0" class="vertex" slot="1" />
		<element type="rgb_float" name="TEXCOORD" index="1" class="vertex" slot="2" />
		<element type="rgb_float" name="TEXCOORD" index="2" class="vertex" slot="2" />
		<element type="rgb_float" name="TEXCOORD" index="3" class="vertex" slot="2" />
    </layout>
    <vertex>
        <![CDATA[
            struct INSTANCE
            {
                float4x4    m_nMatrix;
                float3      m_nScale;
                float       m_nPadding;
            };
            
            StructuredBuffer<INSTANCE> gs_aInstances    : register(t0);

			struct SOURCEVERTEX
			{
				float3 position                         : POSITION;
				float2 texcoord                         : TEXCOORD0;
				float3 tangent                          : TEXCOORD1;
				float3 bitangent                        : TEXCOORD2;
				float3 normal                           : TEXCOORD3;
                uint instance                           : SV_InstanceId;
			};

			VERTEX SourceVertexProgram(in SOURCEVERTEX kSource)
			{
                INSTANCE kInstance = gs_aInstances[kSource.instance];
                float4x4 nObject = kInstance.m_nMatrix;
				float3x3 nBasis  = transpose(nObject);

				VERTEX kVertex;
				kVertex.position = mul(nObject, float4(kSource.position * kInstance.m_nScale, 1.0f));
				kVertex.texcoord = kSource.texcoord;
				kVertex.texbasis = float3x3(kSource.tangent, kSource.bitangent, kSource.normal);
				kVertex.texbasis = mul(kVertex.texbasis, nBasis);
				return kVertex;
			}
        ]]>
    </vertex>
</program>
